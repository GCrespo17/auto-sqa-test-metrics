name: Update Confluence to Google Sheets

on:
  # Permite ejecución manual desde GitHub
  workflow_dispatch:
  
  # Webhook - cronjob.org llamará a este endpoint
  repository_dispatch:
    types: [run-update]

jobs:
  update-sheets:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run UpdateFunctionalResults
        env:
          CONFLUENCE_URL: ${{ secrets.CONFLUENCE_URL }}
          CONFLUENCE_USERNAME: ${{ secrets.CONFLUENCE_USERNAME }}
          CONFLUENCE_API_TOKEN: ${{ secrets.CONFLUENCE_API_TOKEN }}
          CONFLUENCE_FUNCTIONAL_PAGE_ID: ${{ secrets.CONFLUENCE_FUNCTIONAL_PAGE_ID }}
          GOOGLE_SPREADSHEET_ID: ${{ secrets.GOOGLE_SPREADSHEET_ID }}
          GOOGLE_CREDENTIALS: ${{ secrets.GOOGLE_CREDENTIALS }}
          GOOGLE_FUNCTIONAL_PAGE_CELL_RANGE: ${{ secrets.GOOGLE_FUNCTIONAL_PAGE_CELL_RANGE }}
        run: python UpdateFunctionalResults.py

      - name: Run UpdateDefectEficiencyRemoval
        env:
          CONFLUENCE_URL: ${{ secrets.CONFLUENCE_URL }}
          CONFLUENCE_USERNAME: ${{ secrets.CONFLUENCE_USERNAME }}
          CONFLUENCE_API_TOKEN: ${{ secrets.CONFLUENCE_API_TOKEN }}
          CONFLUENCE_WALKTHROUGH_PAGE_ID: ${{ secrets.CONFLUENCE_WALKTHROUGH_PAGE_ID }}
          CONFLUENCE_FUNCTIONAL_PAGE_ID: ${{ secrets.CONFLUENCE_FUNCTIONAL_PAGE_ID }}
          GOOGLE_SPREADSHEET_ID: ${{ secrets.GOOGLE_SPREADSHEET_ID }}
          GOOGLE_CREDENTIALS: ${{ secrets.GOOGLE_CREDENTIALS }}
          GOOGLE_DRE_WALK_CELL: ${{ secrets.GOOGLE_DRE_WALK_CELL }}
          GOOGLE_DRE_FUNCTIONAL_CELL: ${{ secrets.GOOGLE_DRE_FUNCTIONAL_CELL }}
        run: python UpdateDefectEficiencyRemoval.py
